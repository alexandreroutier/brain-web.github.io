<!DOCTYPE html>
<html lang="en">
    <head>
        <title>BrainWeb</title>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet" type="text/css">
        <link href="https://cdn.jsdelivr.net/npm/quasar@1.9.10/dist/quasar.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdn.jsdelivr.net/npm/animate.css@^3.5.2/animate.min.css" rel="stylesheet">

        <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
        <link href="https://fonts.googleapis.com/css?family=Raleway:100,300,400,500,900" rel="stylesheet">

        <link rel="stylesheet" type="text/css" href="/css/main.css">
    </head>


    <body>

        <!-- Firebase authentication -->
        <div id="firebaseui-auth-container" class="auth-dialog"></div>
        <div id="account-details" class="auth-dialog"></div>

    <!-- navigation bar -->
        <!-- currently, the fixed top class is added, so it sticks to the top -->
        <!-- data value of nav bar corresponds to id in each section -->
        <nav class="navbar navbar-expand-lg fixed-top ">

            <a class="navbar-brand" href="/" >
                <div class="logo_brainweb"><p style="padding-left:3.7em;color:white;cursor:pointer;font-size:14px;font-weight:300;line-height:2.7;vertical-align: middle;">BrainWeb</p></div>
            </a>

            <button class="navbar-toggler landing-page myCollapsedMenuBarIcon" id="myMenuBtn" type="button" data-toggle="collapse" data-target="#myMenu" aria-controls="myMenu" aria-expanded="false" aria-label="Toggle navigation" style="padding:0;border:none; width:1.5em;height:1.5em;" onclick="this.blur();">
            </button>

            <style>
                .userIcon {
                    width:32px;
                    height:32px;
                    clip-path: circle(16px at center);
                }
                #userAvatar {
                    display: none;
                }
                .auth-dialog {
                    position:absolute;
                    left:50%;
                    background:rgba(0,0,0,0.5);
                    transform: translate ( -50%, 0 );
                    z-index: 10;
                }
                #loginStatus a {
                    border-bottom:none;
                }
                #loginStatus a:hover {
                    border-bottom:1px solid white;
                }
                #text {
                    position:absolute;
                    width:1200px;
                    padding:1em;
                    top:7rem;
                    left:50%;
                    transform:translate( -50%, 0);
                    background-image:linear-gradient(rgba(20,20,20,0), rgba(20,20,20,0.25), rgba(20,20,20,0.75), rgba(20,20,20,0.75),rgba(20,20,20,0))
                }
                #network {
                    position:fixed;
                    top:50%;
                    left:50%;
                    transform: translate( -50%, -50%);
                    width:100%;
                }
                [v-cloak] {
                    display: none
                }
                .row {
                    margin-left:4px !important;
                    margin-right:4px !important;
                }
                .col {
                    padding-left:5.6px !important;
                    padding-right:5.6px !important;
                }
            </style>

            <div class="collapse navbar-collapse" id="myMenu" style="width:100%;">
                <ul class="navbar-nav mr-4" >
                    <li class="nav-item">
                        <a class="nav-link" href="/">BrainWeb</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#events">Events</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/projects/">Projects</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/community/">Community</a>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link" id="loginStatus" style="border-bottom:none"><a style="color:white" href="#" onclick="signIn()">Sign In</a></span>
                    </li>
                    <li class="nav-item" id="userAvatar">
                        <img class="userIcon"/>
                    </li>
                </ul>
            </div>
        </nav>

        <div id="q-app">
            <!-- part 4 Community -->
            <div id="community">

                <div id="network"></div>

                <div class="container" style="margin-top: 5em">

                    <div id="text">
                        <h1>Community</h1>
                        <p style="column-count: 2;column-gap: 2em">
                            This is the BrainWeb. If you just logged in, your name should be an isolated dot flying around. Find it, click on it, and add your skills. That will
                            start creating links with others, and you'll become part of the cluster of people sharing similar skills. You can learn more about them by
                            clicking on their dots.
                        </p>
                    </div>

                    <div v-cloak class="row">

                        <!-- Person's card -->
                        <div v-if="cardPersonName !== userName">
                            <q-dialog v-model="displayCard">
                            <q-card style="height:300px;width:300px">
                                <q-card-section>
                                <div class="row no-wrap items-center">
                                    <div v-cloak class="col text-h6 ellipsis">
                                    {{cardPersonName}}
                                    </div>
                                </div>
                                </q-card-section>
                                <q-separator></q-separator>
                                <q-card-section>
                                <q-chip v-cloak color="primary" v-for="skill in cardPersonSkills">
                                    {{skill}}
                                </q-chip>
                                </q-card-section>
                            </q-card>
                        </q-dialog>
                        </div>
                    
                        <div v-else>
                        <q-dialog v-model="displayCard">
                            <q-card style="height:300px;width:300px">
                            <q-card-section>
                                <div class="row no-wrap items-center">
                                <div v-cloak class="col text-h6 ellipsis">
                                    {{userName}}
                                </div>
                                </div>
                            </q-card-section>
                            <q-card-section>
                                <q-select
                                label="Skills"
                                filled
                                v-model="people[people.map((o)=>o.name).indexOf(userName)].skills"
                                use-input
                                use-chips
                                multiple
                                hide-dropdown-icon
                                input-debounce="0"
                                new-value-mode="add-unique"
                                :options="options"
                                @filter="filterFn"
                                @new-value="createValue"
                                @input="draw"
                                ></q-select>
                            </q-card-section>
                            </q-card>
                        </q-dialog>
                        </div>
                                                
                    </div>
                </div>
            </div>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/vue@^2.0.0/dist/vue.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/quasar@1.9.10/dist/quasar.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/quasar@1.9.10/dist/icon-set/svg-material-icons.umd.min.js"></script>
        <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.5.0/firebase-ui-auth.css" />
        <script defer src="https://www.gstatic.com/firebasejs/ui/4.5.0/firebase-ui-auth.js"></script>
        <script defer src="https://www.gstatic.com/firebasejs/7.12.0/firebase-app.js"></script>
        <script defer src="https://www.gstatic.com/firebasejs/7.12.0/firebase-auth.js"></script>
        <script defer src="https://www.gstatic.com/firebasejs/7.12.0/firebase-database.js"></script>
        <script src="https://www.lactame.com/lib/ml/4.0.0/ml.min.js"></script>

        <script type="module">
            const circleName = "MiserableSkills";
            let main;
            let network;
            let app;
            const skills = [];

            function initApp() {
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        const {displayName, email, emailVerified, photoURL, uid, phoneNumber, providerData} = user;
                        user.getIdToken().then(function(accessToken) {
                            app.userSignedIn = true;
                            app.userName = displayName;
                            app.userPicture = photoURL;
                            document.querySelector("#userAvatar img").src = photoURL;
                            document.querySelector("#userAvatar").style.display = "inline-block";
                            document.getElementById("loginStatus").innerHTML = `${displayName} (<a style="color:white" href="#" onclick="signOut()">Sign Out</a>)`;
                        });
                    } else {
                        app.userSignedIn = false;
                        app.userName = null;
                        app.userPicture = null;
                        document.querySelector("#userAvatar").style.display = "none";
                        document.querySelector("#userAvatar img").src = "";
                        document.getElementById("loginStatus").innerHTML = `<a style="color:white" href="#" onclick="signIn()">Sign In</a>`;
                    }
                }, function(error) {
                    console.log(error);
                });
            }

            function signIn() {
                uiAuth.start('#firebaseui-auth-container', uiConfig);
            }
            window.signIn = signIn;

            function signOut() {
                firebase.auth().signOut();
            }
            window.signOut = signOut;

            function update(data) {
                const str = JSON.stringify(data);
                const obj = {};
                obj[circleName] = str;
                firebase.database().ref('circles').update(obj)
                .then(function(snapshot) {
                    console.log('update: success');
                }, function(error) {
                    console.log('update: error', error);
                });
            }

            function listen() {
                var circles = firebase.database().ref(`circles/${circleName}`);
                circles.on('value', (s) => {
                    const circle = s.val();
                    if(circle === null) {
                    return;
                    }
                    databaseToPeople(circle);
                    addCurrentUser();
                    peopleToNetwork(app.people);
                    cluster(network);
                });
            }

            function startFirebase() {
                uiAuth = new firebaseui.auth.AuthUI(firebase.auth());
                window.addEventListener('load', function() {
                    initApp();
                    listen();
                });
            }
            window.startFirebase = startFirebase;

            function databaseToPeople(data) {
                const oldPeople = app.people;

                const incomingPeople = JSON.parse(data);
                const newPeople = incomingPeople.filter((person) => !(oldPeople.map((o)=>o.name).includes(person.name)));
                for(let p of newPeople) {
                app.people.push(p);
                }

                for(let p of incomingPeople) {
                    for(let s of p.skills) {
                        if(!skills.includes(s)) {
                            skills.push(s);
                        }
                    }
                }
            }

            function peopleToNetwork(people) {
                const nodes = people.map((p) => {
                    return {id:p.name, group: 1}
                })
                const links = [];
                for(let i=0;i<people.length-1;i++) {
                    for(let j=i+1;j<people.length;j++) {
                        const src = people[i];
                        const trg = people[j];
                        const srcSkills = src.skills;
                        const trgSkills = trg.skills;
                        const common = srcSkills.filter(skill => trgSkills.includes(skill));
                        if(common.length > 0) {
                            links.push({source:src.name, target:trg.name, value: common.length});
                        }
                    }
                }
                network = {nodes, links};
                main.redefine("miserable", network);
            }

            function peopleToDatabase(people) {
                const arr = []
                for(let p of people) {
                    arr.push(JSON.parse(JSON.stringify(p)));
                }
                update(arr);
            }

            function addCurrentUser() {
                if(app.userName === null) {
                    return;
                }

                const index = app.people.map((o)=>o.name).indexOf(app.userName);
                if(index === -1) {
                    app.people.push({
                        name: app.userName,
                        skills: []
                    });
                }
            }

            import {Runtime, Inspector} from "https://cdn.jsdelivr.net/npm/@observablehq/runtime@4/dist/runtime.js";
            import notebook from "https://api.observablehq.com/@r03ert0/circle-of-friends.js?v=3";

            function startForceLayout() {
                main = new Runtime().module(notebook, (name) => {
                switch(name) {
                    case "viewof mychart":
                        return new Inspector(document.getElementById("network"));
                    case "mychart":
                        return {fulfilled(value) {
                            app.displayCard = true;
                            app.cardPersonName = app.people[value].name;
                            app.cardPersonSkills = app.people[value].skills;
                        }};
                }
                });

                network = { "nodes": [], "links": [] };
                main.redefine("miserable", network);
                main.redefine("myStrength", 150);
                main.redefine("myRadius", 10);
                main.redefine("myHeight", 610);
            }

            Quasar.Dark.set(true)

            app = new Vue({
                el: '#q-app',
                data () {
                    return {
                        people: [],
                        options: skills,
                        userSignedIn: false,
                        userName: null,
                        userPicture: null,
                        displayCard: false,
                        cardPersonName: "",
                        cardPersonSkills: []
                    }
                },
                methods: {
                    filterFn (val, update, abort) {
                        update(() => {
                            const needle = val.toLowerCase()
                            this.options = skills.filter(v => v.toLowerCase().indexOf(needle) > -1)
                        })
                    },
                    createValue (val, done) {
                        skills.push(val)
                        done(val)
                    },
                    addPerson (e) {
                        this.people.push({name:"",skills:[]})
                    },
                    deletePerson (e, index) {
                        this.people.splice(index,1)
                        event.stopPropagation()
                    },
                    draw (e) {
                        peopleToNetwork(this.people);
                        peopleToDatabase(this.people);
                        cluster(network);
                    },
                    goTo (url) {
                        window.location = url
                    }
                }
            });

            function cluster(people) {
                const N = people.nodes.length;
                const data = [];
                const names = people.nodes.map((o)=>o.id);
                for(let i=0;i<N;i++) {
                    data[i] = new Float32Array(N);
                    data[i][i] = 1;
                }
                for(let e of people.links) {
                    const i = names.indexOf(e.source);
                    const j = names.indexOf(e.target);
                    data[i][j] += 1;
                    data[j][i] += 1;
                }
                const {agnes} = ML.HClust;
                const tree = agnes(data, {
                    method: 'ward'
                });
                const ngroups = parseInt(Math.sqrt(N));
                const groups = tree.group(ngroups);
                for(let i=0;i<groups.children.length;i++) {
                    if(groups.children[i].constructor.name === "ClusterLeaf") {
                        people.nodes[groups.children[i].index].group = 0;
                    } else {
                        for(let p of groups.children[i].index) {
                            people.nodes[p.index].group = i;
                        }
                    }
                }
            }
            startForceLayout();

        </script>
        <script defer src="/js/init-firebase.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->

    </body>
</html>
